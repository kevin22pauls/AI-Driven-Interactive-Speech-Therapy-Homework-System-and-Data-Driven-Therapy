<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recording Analysis</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 20px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 16px; font-weight: 600; }
    .header .meta { font-size: 12px; opacity: 0.9; margin-top: 4px; }
    .header .back-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 13px;
      transition: background 0.2s;
    }
    .header .back-btn:hover { background: rgba(255,255,255,0.3); }

    /* Tabs */
    .tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 20px;
    }
    .tab-btn {
      padding: 14px 24px;
      border: none;
      background: none;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #667eea; }
    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    /* Tab Content */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .tab-panel {
      display: none;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
    }
    .tab-panel.active {
      display: block;
    }

    /* Cards */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      margin-bottom: 16px;
    }
    .card h3 {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    /* Transcript boxes */
    .transcript-box {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border: 1px solid #e2e8f0;
    }
    .transcript-box:last-child { margin-bottom: 0; }
    .transcript-box .label {
      font-size: 11px;
      text-transform: uppercase;
      color: #667eea;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .transcript-box .text {
      font-size: 16px;
      line-height: 1.5;
    }
    .transcript-box.prompt .text { color: #64748b; }
    .transcript-box.actual .text { color: #059669; font-weight: 500; }

    /* Metrics grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }
    .metric {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }
    .metric .value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }
    .metric .label {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
      text-transform: uppercase;
    }

    /* Classification badge */
    .classification {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 16px;
    }
    .classification.correct { background: #d1fae5; color: #065f46; }
    .classification.partial { background: #fef3c7; color: #92400e; }
    .classification.wrong { background: #fee2e2; color: #991b1b; }

    /* Chips */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .chip {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }
    .chip.sub { background: #fef3c7; color: #92400e; }
    .chip.del { background: #fee2e2; color: #991b1b; }
    .chip.ins { background: #dbeafe; color: #1e40af; }
    .chip.phoneme { background: #e0e7ff; color: #3730a3; font-family: monospace; }

    /* Phoneme sequence */
    .phoneme-sequence {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 12px;
    }
    .ph {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
    }
    .ph.good { background: #d1fae5; color: #065f46; }
    .ph.warn { background: #fef3c7; color: #92400e; }
    .ph.bad { background: #fee2e2; color: #991b1b; }
    .ph.neutral { background: #f1f5f9; color: #475569; }

    /* Error list */
    .error-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .error-item {
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      border-left: 4px solid #f59e0b;
    }
    .error-item.deletion { border-left-color: #ef4444; }
    .error-item.insertion { border-left-color: #3b82f6; }
    .error-item .word { font-weight: 600; color: #1e293b; font-size: 14px; }
    .error-item .type {
      font-size: 10px;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      background: #e2e8f0;
      color: #475569;
      margin-left: 8px;
    }
    .error-item .detail { color: #64748b; margin-top: 6px; font-size: 13px; }
    .error-item .clinical-sig {
      font-size: 12px;
      color: #b45309;
      margin-top: 6px;
      font-style: italic;
    }

    /* SSI badge */
    .ssi-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 12px;
    }
    .ssi-badge.normal { background: #d1fae5; color: #065f46; }
    .ssi-badge.mild { background: #fef3c7; color: #92400e; }
    .ssi-badge.moderate { background: #fed7aa; color: #9a3412; }
    .ssi-badge.severe { background: #fee2e2; color: #991b1b; }

    /* Normative level badges */
    .norm-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 6px;
      vertical-align: middle;
    }
    .norm-badge.normal { background: #d1fae5; color: #065f46; }
    .norm-badge.below { background: #fee2e2; color: #991b1b; }
    .norm-badge.above { background: #dbeafe; color: #1e40af; }
    .norm-badge.unknown { background: #f1f5f9; color: #64748b; }

    /* Pause chips */
    .pause-chip {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
    }
    .pause-chip.anomic { background: #fef3c7; color: #92400e; }
    .pause-chip.hesitation { background: #dbeafe; color: #1e40af; }
    .pause-chip.block { background: #fee2e2; color: #991b1b; }

    /* Clinical notes */
    .notes-list {
      list-style: none;
    }
    .notes-list li {
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
      color: #b45309;
      font-size: 14px;
      line-height: 1.5;
    }
    .notes-list li:last-child { border-bottom: none; }
    .notes-list li::before {
      content: "•";
      margin-right: 10px;
      color: #667eea;
    }

    /* Boolean indicators */
    .bool-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .bool-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .bool-indicator {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .bool-indicator.yes { background: #d1fae5; color: #065f46; }
    .bool-indicator.no { background: #f1f5f9; color: #64748b; }
    .bool-label { font-size: 13px; color: #1e293b; }

    /* Loading & error */
    .loading {
      text-align: center;
      padding: 60px;
      color: #64748b;
      font-size: 16px;
    }
    .error-msg {
      background: #fee2e2;
      color: #991b1b;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">Loading analysis...</div>
  </div>

  <script>
    const BACKEND = "http://127.0.0.1:8001";

    async function loadRecording() {
      const params = new URLSearchParams(window.location.search);
      const recordingId = params.get('recording_id');

      if (!recordingId) {
        document.getElementById('app').innerHTML = '<div class="error-msg">No recording ID specified</div>';
        return;
      }

      try {
        const response = await fetch(`${BACKEND}/recording/${recordingId}`);
        if (!response.ok) throw new Error('Recording not found');
        const rec = await response.json();
        renderPage(rec);
      } catch (error) {
        document.getElementById('app').innerHTML = `<div class="error-msg">Error: ${error.message}</div>`;
      }
    }

    function renderPage(rec) {
      const patientId = rec.patient_id || rec.session_id?.split('_')[0] || 'N/A';
      const createdAt = new Date(rec.created_at).toLocaleString();

      const html = `
        <div class="header">
          <div>
            <h1>Analysis #${rec.id}: ${rec.object_name || 'Unknown'}</h1>
            <div class="meta">Patient: ${patientId} | Mode: ${rec.analysis_mode || 'standard'} | Disorder: ${rec.disorder_type || 'N/A'} | ${createdAt}</div>
          </div>
          <a href="/dashboard" class="back-btn">← Dashboard</a>
        </div>

        <div class="tabs">
          <button class="tab-btn active" data-tab="transcript">Transcript</button>
          <button class="tab-btn" data-tab="semantic">Semantic</button>
          <button class="tab-btn" data-tab="phoneme">Phoneme</button>
          <button class="tab-btn" data-tab="fluency">Fluency</button>
          <button class="tab-btn" data-tab="ml">ML Analysis</button>
          <button class="tab-btn" data-tab="raw">Raw JSON</button>
        </div>

        <div class="tab-content">
          ${renderTranscriptTab(rec)}
          ${renderSemanticTab(rec)}
          ${renderPhonemeTab(rec)}
          ${renderFluencyTab(rec)}
          ${renderMLTab(rec)}
          ${renderRawJSONTab(rec)}
        </div>
      `;

      document.getElementById('app').innerHTML = html;
      initTabs();
    }

    function renderTranscriptTab(rec) {
      // Show phoneme sequence if available
      let phonemeSequence = '';
      if (rec.ml_detected_phonemes && rec.ml_detected_phonemes.length > 0) {
        const phonemes = rec.ml_detected_phonemes.map(p => `<span style="background:#e0e7ff;color:#3730a3;padding:2px 6px;border-radius:4px;font-family:monospace;font-size:11px;margin:2px;">${p}</span>`).join(' ');
        phonemeSequence = `
          <div style="margin-top: 12px; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
            <div style="font-size: 11px; color: #64748b; margin-bottom: 8px; text-transform: uppercase;">Detected Phonemes (ARPAbet)</div>
            <div style="display: flex; flex-wrap: wrap; gap: 4px;">${phonemes}</div>
          </div>
        `;
      }

      return `
        <div class="tab-panel active" id="tab-transcript">
          <div class="card">
            <h3>Speech Transcript</h3>
            <div class="transcript-box prompt">
              <div class="label">Prompt / Expected</div>
              <div class="text">${rec.prompt_text || 'N/A'}</div>
            </div>
            <div class="transcript-box actual">
              <div class="label">Whisper Transcript (ASR Output)</div>
              <div class="text">${rec.transcript || '(no speech detected)'}</div>
            </div>
            ${phonemeSequence}
          </div>
        </div>
      `;
    }

    function renderSemanticTab(rec) {
      return `
        <div class="tab-panel" id="tab-semantic">
          <div class="card">
            <h3>Semantic Evaluation</h3>
            <span class="classification ${(rec.semantic_classification || '').toLowerCase()}">${rec.semantic_classification || 'N/A'}</span>

            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.semantic_score != null ? (rec.semantic_score * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Overall Similarity</div>
              </div>
              <div class="metric">
                <div class="value">${rec.direct_similarity != null ? (rec.direct_similarity * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Direct Similarity</div>
              </div>
              <div class="metric">
                <div class="value">${rec.category_similarity != null ? (rec.category_similarity * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Category Similarity</div>
              </div>
              <div class="metric">
                <div class="value">${rec.wer != null ? (rec.wer * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Word Error Rate</div>
              </div>
              <div class="metric">
                <div class="value">${rec.speech_rate != null ? rec.speech_rate.toFixed(1) : 'N/A'}</div>
                <div class="label">Words/Min</div>
              </div>
            </div>
            <p style="font-size: 11px; color: #64748b; margin-top: 12px;">
              Direct = embedding similarity | Category = WordNet category match | Overall = combined score
            </p>

            <div class="bool-grid">
              <div class="bool-item">
                <span class="bool-indicator ${rec.circumlocution_detected ? 'yes' : 'no'}">${rec.circumlocution_detected ? '✓' : '–'}</span>
                <span class="bool-label">Circumlocution Detected</span>
              </div>
              <div class="bool-item">
                <span class="bool-indicator ${rec.conduite_d_approche_detected ? 'yes' : 'no'}">${rec.conduite_d_approche_detected ? '✓' : '–'}</span>
                <span class="bool-label">Self-Correction (Conduite)</span>
              </div>
              <div class="bool-item">
                <span class="bool-indicator ${rec.semantic_paraphasia?.detected ? 'yes' : 'no'}">${rec.semantic_paraphasia?.detected ? '✓' : '–'}</span>
                <span class="bool-label">Semantic Paraphasia</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderPhonemeTab(rec) {
      // Error type counts
      let errorChips = '';
      if (rec.phoneme_errors && rec.phoneme_errors.length > 0) {
        const counts = { sub: 0, del: 0, ins: 0 };
        rec.phoneme_errors.forEach(e => {
          if ((e.type || '').includes('deletion')) counts.del++;
          else if ((e.type || '').includes('insertion')) counts.ins++;
          else counts.sub++;
        });
        if (counts.sub) errorChips += `<span class="chip sub">Substitutions: ${counts.sub}</span>`;
        if (counts.del) errorChips += `<span class="chip del">Deletions: ${counts.del}</span>`;
        if (counts.ins) errorChips += `<span class="chip ins">Insertions: ${counts.ins}</span>`;
      }

      // Problematic phonemes
      let problematicChips = '';
      if (rec.problematic_phonemes && Object.keys(rec.problematic_phonemes).length > 0) {
        Object.entries(rec.problematic_phonemes).forEach(([p, c]) => {
          problematicChips += `<span class="chip phoneme">/${p}/ ×${c}</span>`;
        });
      }

      // Error list
      let errorList = '';
      if (rec.phoneme_errors && rec.phoneme_errors.length > 0) {
        rec.phoneme_errors.forEach(err => {
          const errClass = (err.type || '').includes('deletion') ? 'deletion' : (err.type || '').includes('insertion') ? 'insertion' : '';
          const shortType = (err.type || 'unknown').replace('phonetically_similar_', '').replace('phonetically_dissimilar_', '');
          const sig = err.clinical_significance ? `<div class="clinical-sig">${err.clinical_significance}</div>` : '';
          errorList += `
            <div class="error-item ${errClass}">
              <span class="word">${err.word || '-'}</span>
              <span class="type">${shortType}</span>
              <div class="detail">/${err.expected || '-'}/ → /${err.actual || '-'}/</div>
              ${sig}
            </div>
          `;
        });
      } else {
        errorList = '<p style="color: #64748b;">No phoneme errors detected</p>';
      }

      // Phoneme class errors section
      let classErrorsSection = '';
      if (rec.phoneme_class_errors && Object.keys(rec.phoneme_class_errors).length > 0) {
        let classChips = '';
        Object.entries(rec.phoneme_class_errors).forEach(([cls, count]) => {
          const colors = {
            'stops': '#ef4444', 'fricatives': '#f59e0b', 'affricates': '#84cc16',
            'nasals': '#06b6d4', 'liquids': '#8b5cf6', 'glides': '#ec4899',
            'vowels': '#3b82f6'
          };
          const bg = colors[cls.toLowerCase()] || '#64748b';
          classChips += `<span style="background: ${bg}20; color: ${bg}; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin: 2px;">${cls}: ${count}</span>`;
        });
        classErrorsSection = `
          <div class="card">
            <h3>Errors by Phoneme Class</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">${classChips}</div>
            <p style="font-size: 11px; color: #64748b; margin-top: 12px;">
              Stops (p,b,t,d,k,g) | Fricatives (f,v,s,z,sh) | Nasals (m,n,ng) | Liquids (l,r) | Glides (w,y)
            </p>
          </div>
        `;
      }

      // Error pattern analysis section
      let patternSection = '';
      if (rec.error_pattern_analysis && Object.keys(rec.error_pattern_analysis).length > 0) {
        let patternItems = '';
        const patterns = rec.error_pattern_analysis;
        if (patterns.dominant_error_type) {
          patternItems += `<div class="metric"><div class="value" style="font-size: 16px;">${patterns.dominant_error_type}</div><div class="label">Dominant Error Type</div></div>`;
        }
        if (patterns.most_affected_position) {
          patternItems += `<div class="metric"><div class="value" style="font-size: 16px;">${patterns.most_affected_position}</div><div class="label">Most Affected Position</div></div>`;
        }
        if (patterns.substitution_pattern) {
          patternItems += `<div class="metric"><div class="value" style="font-size: 16px;">${patterns.substitution_pattern}</div><div class="label">Substitution Pattern</div></div>`;
        }
        if (patterns.consistency) {
          patternItems += `<div class="metric"><div class="value" style="font-size: 16px;">${patterns.consistency}</div><div class="label">Error Consistency</div></div>`;
        }
        if (patternItems) {
          patternSection = `
            <div class="card">
              <h3>Error Pattern Analysis</h3>
              <div class="metrics-grid">${patternItems}</div>
            </div>
          `;
        }
      }

      // ML Alignment section
      let alignmentSection = '';
      if (rec.ml_alignment && rec.ml_alignment.length > 0) {
        let alignmentPairs = '';
        rec.ml_alignment.slice(0, 20).forEach(pair => {
          const match = pair.expected === pair.detected;
          const bgColor = match ? '#d1fae5' : '#fee2e2';
          const textColor = match ? '#065f46' : '#991b1b';
          alignmentPairs += `<span style="background: ${bgColor}; color: ${textColor}; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 11px; margin: 2px;">${pair.expected || '?'}→${pair.detected || '?'}</span>`;
        });
        if (rec.ml_alignment.length > 20) {
          alignmentPairs += `<span style="color: #64748b; font-size: 11px;">... +${rec.ml_alignment.length - 20} more</span>`;
        }
        alignmentSection = `
          <div class="card">
            <h3>ML Phoneme Alignment (Expected → Detected)</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 4px;">${alignmentPairs}</div>
            <p style="font-size: 11px; color: #64748b; margin-top: 12px;">
              <span style="background: #d1fae5; padding: 2px 6px; border-radius: 4px;">Match</span>
              <span style="background: #fee2e2; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Mismatch</span>
            </p>
          </div>
        `;
      }

      // ML IPA section
      let ipaSection = '';
      if (rec.ml_detected_ipa && rec.ml_detected_ipa.length > 0) {
        const ipaPhonemes = rec.ml_detected_ipa.map(p => `<span style="background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; margin: 2px;">${p}</span>`).join(' ');
        ipaSection = `
          <div class="card">
            <h3>Detected Phonemes (IPA)</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 4px;">${ipaPhonemes}</div>
          </div>
        `;
      }

      return `
        <div class="tab-panel" id="tab-phoneme">
          <div class="card">
            <h3>Phoneme Analysis Summary</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.per != null ? (rec.per * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">PER</div>
              </div>
              <div class="metric">
                <div class="value">${rec.wper != null ? (rec.wper * 100).toFixed(0) + '%' : 'N/A'}${rec.wper_normative_level ? `<span class="norm-badge ${rec.wper_normative_level}">${rec.wper_normative_level}</span>` : ''}</div>
                <div class="label">WPER</div>
              </div>
              <div class="metric">
                <div class="value">${rec.total_phonemes || 0}</div>
                <div class="label">Total Phonemes</div>
              </div>
              <div class="metric">
                <div class="value">${rec.phoneme_errors ? rec.phoneme_errors.length : 0}</div>
                <div class="label">Errors</div>
              </div>
            </div>
            ${errorChips ? `<div class="chips">${errorChips}</div>` : ''}
            ${problematicChips ? `<div class="chips">${problematicChips}</div>` : ''}
          </div>

          ${classErrorsSection}
          ${patternSection}

          <div class="card">
            <h3>Phoneme Errors Detail</h3>
            <div class="error-list">
              ${errorList}
            </div>
          </div>

          ${alignmentSection}
          ${ipaSection}
        </div>
      `;
    }

    function renderFluencyTab(rec) {
      // Pause chips
      let pauseChips = '';
      if (rec.pauses && rec.pauses.length > 0) {
        rec.pauses.slice(0, 10).forEach(p => {
          pauseChips += `<span class="chip pause-chip ${p.type || 'hesitation'}">${p.type || '?'} ${p.duration?.toFixed(1) || '?'}s</span>`;
        });
      }

      // Clinical notes
      const allNotes = [...(rec.clinical_notes || []), ...(rec.fluency_notes || [])];
      let notesList = '';
      if (allNotes.length > 0) {
        allNotes.forEach(n => {
          notesList += `<li>${n}</li>`;
        });
      } else {
        notesList = '<li style="color: #64748b;">No clinical notes</li>';
      }

      // Stuttering events
      let stutterSection = '';
      if (rec.stuttering_events && rec.stuttering_events.length > 0) {
        let stutterList = '';
        rec.stuttering_events.forEach(evt => {
          stutterList += `
            <div class="error-item" style="border-left-color: #a855f7;">
              <span class="word">${evt.word || '-'}</span>
              <span class="type" style="background: #f3e8ff; color: #7c3aed;">${evt.type || 'stutter'}</span>
              <div class="detail">${evt.description || ''}</div>
            </div>
          `;
        });
        stutterSection = `
          <div class="card">
            <h3>Stuttering Events</h3>
            <div class="error-list">${stutterList}</div>
          </div>
        `;
      }

      // Rate trend badge
      const rateTrendBadge = rec.rate_trend ?
        `<span class="norm-badge ${rec.rate_trend === 'stable' ? 'normal' : rec.rate_trend === 'slowing' ? 'below' : 'above'}">${rec.rate_trend}</span>` : '';

      return `
        <div class="tab-panel" id="tab-fluency">
          <div class="card">
            <h3>Fluency Metrics</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.longest_fluent_run != null ? rec.longest_fluent_run : 'N/A'}</div>
                <div class="label">Longest Fluent Run</div>
              </div>
              <div class="metric">
                <div class="value">${rec.fluency_percentage != null ? rec.fluency_percentage.toFixed(0) + '%' : 'N/A'}${rec.fluency_normative_level ? `<span class="norm-badge ${rec.fluency_normative_level}">${rec.fluency_normative_level}</span>` : ''}</div>
                <div class="label">Fluency %</div>
              </div>
              <div class="metric">
                <div class="value">${rec.pause_ratio != null ? (rec.pause_ratio * 100).toFixed(0) + '%' : '0%'}</div>
                <div class="label">Pause Ratio</div>
              </div>
              <div class="metric">
                <div class="value">${rec.pauses ? rec.pauses.length : 0}</div>
                <div class="label">Total Pauses</div>
              </div>
              <div class="metric">
                <div class="value">${rec.anomic_pause_count || 0}</div>
                <div class="label">Anomic Pauses</div>
              </div>
              <div class="metric">
                <div class="value">${rec.apraxic_pause_count || 0}</div>
                <div class="label">Apraxic Pauses</div>
              </div>
              <div class="metric">
                <div class="value">${rec.articulation_rate != null ? rec.articulation_rate.toFixed(1) : 'N/A'}${rec.articulation_rate_normative_level ? `<span class="norm-badge ${rec.articulation_rate_normative_level}">${rec.articulation_rate_normative_level}</span>` : ''}</div>
                <div class="label">Articulation Rate</div>
              </div>
              <div class="metric">
                <div class="value">${rec.mean_pause_duration != null ? rec.mean_pause_duration.toFixed(2) + 's' : 'N/A'}</div>
                <div class="label">Avg Pause Duration</div>
              </div>
            </div>

            ${rec.ssi_severity ? `<span class="ssi-badge ${rec.ssi_severity}">SSI-4: ${rec.ssi_severity.toUpperCase()} (Score: ${rec.ssi_total_score || '?'})</span>` : ''}

            ${pauseChips ? `<div class="chips">${pauseChips}</div>` : ''}
          </div>

          <!-- NEW: Dysfluency & Rate Metrics -->
          <div class="card">
            <h3>Dysfluency Rates</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.hesitation_count != null ? rec.hesitation_count : 'N/A'}</div>
                <div class="label">Hesitations</div>
              </div>
              <div class="metric">
                <div class="value">${rec.block_count != null ? rec.block_count : 'N/A'}</div>
                <div class="label">Blocks</div>
              </div>
              <div class="metric">
                <div class="value">${rec.dysfluencies_per_100_words != null ? rec.dysfluencies_per_100_words.toFixed(1) : 'N/A'}</div>
                <div class="label">Dysfluencies/100 Words</div>
              </div>
              <div class="metric">
                <div class="value">${rec.dysfluencies_per_minute != null ? rec.dysfluencies_per_minute.toFixed(1) : 'N/A'}</div>
                <div class="label">Dysfluencies/Min</div>
              </div>
            </div>
          </div>

          <!-- NEW: Speech Rate & Timing -->
          <div class="card">
            <h3>Speech Rate & Timing</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.speaking_rate != null ? rec.speaking_rate.toFixed(1) : 'N/A'}</div>
                <div class="label">Speaking Rate (syl/min)</div>
              </div>
              <div class="metric">
                <div class="value">${rec.pause_adjusted_rate != null ? rec.pause_adjusted_rate.toFixed(1) : 'N/A'}</div>
                <div class="label">Pause-Adjusted Rate</div>
              </div>
              <div class="metric">
                <div class="value">${rec.phonation_time != null ? rec.phonation_time.toFixed(2) + 's' : 'N/A'}</div>
                <div class="label">Phonation Time</div>
              </div>
              <div class="metric">
                <div class="value">${rec.phonation_ratio != null ? (rec.phonation_ratio * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Phonation Ratio</div>
              </div>
              <div class="metric">
                <div class="value">${rec.pathological_pause_ratio != null ? (rec.pathological_pause_ratio * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Pathological Pause %</div>
              </div>
            </div>
          </div>

          <!-- NEW: Rate Variability -->
          <div class="card">
            <h3>Rate Variability ${rateTrendBadge}</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.local_cv != null ? rec.local_cv.toFixed(2) : 'N/A'}</div>
                <div class="label">Local CV</div>
              </div>
              <div class="metric">
                <div class="value">${rec.global_cv != null ? rec.global_cv.toFixed(2) : 'N/A'}</div>
                <div class="label">Global CV</div>
              </div>
              <div class="metric">
                <div class="value">${rec.normalized_pvi != null ? rec.normalized_pvi.toFixed(2) : 'N/A'}</div>
                <div class="label">Normalized PVI</div>
              </div>
              <div class="metric">
                <div class="value">${rec.speech_rate_variability != null ? rec.speech_rate_variability.toFixed(2) : 'N/A'}</div>
                <div class="label">Rate Variability</div>
              </div>
            </div>
            <p style="font-size: 11px; color: #64748b; margin-top: 12px;">
              CV = Coefficient of Variation | PVI = Pairwise Variability Index | Higher values = more variable speech rate
            </p>
          </div>

          <!-- NEW: Fluency Percentages (3 types) -->
          <div class="card">
            <h3>Fluency Scores (Multiple Methods)</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.standard_fluency_pct != null ? rec.standard_fluency_pct.toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Standard Fluency %</div>
              </div>
              <div class="metric">
                <div class="value">${rec.weighted_fluency_pct != null ? rec.weighted_fluency_pct.toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Weighted Fluency %</div>
              </div>
              <div class="metric">
                <div class="value">${rec.clinical_fluency_pct != null ? rec.clinical_fluency_pct.toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Clinical Fluency %</div>
              </div>
              <div class="metric">
                <div class="value">${rec.lfr_ratio != null ? (rec.lfr_ratio * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">LFR Ratio</div>
              </div>
            </div>
          </div>

          <!-- NEW: SSI-4 Detailed Breakdown -->
          ${rec.ssi_severity ? `
          <div class="card">
            <h3>SSI-4 Component Scores</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.ssi_frequency_pct != null ? rec.ssi_frequency_pct.toFixed(1) + '%' : 'N/A'}</div>
                <div class="label">Frequency %</div>
              </div>
              <div class="metric">
                <div class="value">${rec.ssi_frequency_score != null ? rec.ssi_frequency_score : 'N/A'}</div>
                <div class="label">Frequency Score (0-10)</div>
              </div>
              <div class="metric">
                <div class="value">${rec.ssi_avg_duration != null ? rec.ssi_avg_duration.toFixed(2) + 's' : 'N/A'}</div>
                <div class="label">Avg Stutter Duration</div>
              </div>
              <div class="metric">
                <div class="value">${rec.ssi_duration_score != null ? rec.ssi_duration_score : 'N/A'}</div>
                <div class="label">Duration Score (0-10)</div>
              </div>
              <div class="metric">
                <div class="value">${rec.ssi_total_score != null ? rec.ssi_total_score : 'N/A'}</div>
                <div class="label">Total SSI-4 Score</div>
              </div>
            </div>
            <p style="font-size: 11px; color: #64748b; margin-top: 12px;">
              SSI-4 = Stuttering Severity Instrument (4th Edition) | Normal: 0-10 | Mild: 11-17 | Moderate: 18-24 | Severe: 25+
            </p>
          </div>
          ` : ''}

          <div class="card">
            <h3>Clinical Notes</h3>
            <ul class="notes-list">${notesList}</ul>
          </div>

          ${stutterSection}
        </div>
      `;
    }

    function renderMLTab(rec) {
      // ML phoneme sequence
      let phonemeSeq = '';
      if (rec.ml_phoneme_scores && rec.ml_phoneme_scores.length > 0) {
        rec.ml_phoneme_scores.forEach(item => {
          const prob = item.probability || 0;
          const cls = prob > 0.9 ? 'good' : prob > 0.7 ? 'warn' : 'bad';
          const match = item.phoneme === item.expected ? '' : '*';
          phonemeSeq += `<span class="ph ${cls}" title="Prob: ${(prob * 100).toFixed(0)}%">${item.phoneme}${match}</span>`;
        });
      } else if (rec.ml_detected_phonemes && rec.ml_detected_phonemes.length > 0) {
        rec.ml_detected_phonemes.forEach(p => {
          phonemeSeq += `<span class="ph neutral">${p}</span>`;
        });
      } else {
        phonemeSeq = '<p style="color: #64748b;">No ML phoneme data available</p>';
      }

      return `
        <div class="tab-panel" id="tab-ml">
          <div class="card">
            <h3>ML Phoneme Analysis (Wav2Vec2)</h3>
            <div class="metrics-grid">
              <div class="metric">
                <div class="value">${rec.ml_per != null ? (rec.ml_per * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">ML PER</div>
              </div>
              <div class="metric">
                <div class="value">${rec.ml_gop != null ? rec.ml_gop.toFixed(2) : 'N/A'}</div>
                <div class="label">GOP Score</div>
              </div>
              <div class="metric">
                <div class="value">${rec.ml_confidence != null ? (rec.ml_confidence * 100).toFixed(0) + '%' : 'N/A'}</div>
                <div class="label">Confidence</div>
              </div>
              <div class="metric">
                <div class="value">${rec.ml_detected_phonemes ? rec.ml_detected_phonemes.length : 0}</div>
                <div class="label">Detected Phonemes</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Detected Phoneme Sequence</h3>
            <p style="font-size: 12px; color: #64748b; margin-bottom: 12px;">
              Colors indicate quality: <span class="ph good">Good (>90%)</span>
              <span class="ph warn">Warning (70-90%)</span>
              <span class="ph bad">Poor (<70%)</span>
              <span style="margin-left: 8px;">* = mismatch with expected</span>
            </p>
            <div class="phoneme-sequence">${phonemeSeq}</div>
          </div>
        </div>
      `;
    }

    function renderRawJSONTab(rec) {
      // Format JSON with proper indentation
      const jsonString = JSON.stringify(rec, null, 2);

      return `
        <div class="tab-panel" id="tab-raw">
          <div class="card">
            <h3>Raw JSON Data</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <p style="font-size: 12px; color: #64748b;">
                Complete recording analysis data in JSON format
              </p>
              <button onclick="copyToClipboard()" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                Copy to Clipboard
              </button>
            </div>
            <pre id="json-content" style="
              background: #1e293b;
              color: #e2e8f0;
              padding: 16px;
              border-radius: 8px;
              overflow-x: auto;
              font-size: 12px;
              line-height: 1.6;
              font-family: 'Courier New', monospace;
              max-height: calc(100vh - 300px);
              overflow-y: auto;
            ">${escapeHtml(jsonString)}</pre>
          </div>
        </div>
      `;
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    function copyToClipboard() {
      const jsonContent = document.getElementById('json-content');
      const text = jsonContent.textContent;

      navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '✓ Copied!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '#667eea';
        }, 2000);
      }).catch(err => {
        alert('Failed to copy: ' + err);
      });
    }

    function initTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Remove active from all
          tabBtns.forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

          // Add active to clicked
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });
    }

    loadRecording();
  </script>
</body>
</html>
