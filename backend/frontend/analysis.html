<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recording Analysis</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px 24px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .header h1 { font-size: 18px; font-weight: 600; }
    .header .meta { font-size: 13px; opacity: 0.9; margin-top: 2px; }
    .header .back-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    .header .back-btn:hover { background: rgba(255,255,255,0.3); }

    /* Tabs */
    .tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 0 24px;
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 16px 28px;
      border: none;
      background: none;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #667eea; background: #f8f9ff; }
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; background: #f8f9ff; }

    /* Main Content - Full Height */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .tab-panel { display: none; height: 100%; }
    .tab-panel.active { display: block; }

    /* Score Cards Row */
    .score-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .score-card {
      background: #fff;
      border-radius: 10px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
    }
    .score-card.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }
    .score-card .value {
      font-size: 42px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 8px;
    }
    .score-card .value.good { color: #10b981; }
    .score-card .value.warn { color: #f59e0b; }
    .score-card .value.bad { color: #ef4444; }
    .score-card.primary .value { color: white; }
    .score-card .label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    .score-card.primary .label { color: rgba(255,255,255,0.85); }
    .score-card .bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      margin-top: 16px;
      overflow: hidden;
    }
    .score-card.primary .bar { background: rgba(255,255,255,0.3); }
    .score-card .bar-fill { height: 100%; border-radius: 3px; }
    .score-card .bar-fill.good { background: #10b981; }
    .score-card .bar-fill.warn { background: #f59e0b; }
    .score-card .bar-fill.bad { background: #ef4444; }
    .score-card.primary .bar-fill { background: white; }

    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .content-grid.full { grid-template-columns: 1fr; }

    /* Cards */
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      overflow: hidden;
    }
    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }
    .card-header h3 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .card-body { padding: 16px; }

    /* Tables */
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    .table.compact { width: auto; }
    .table th {
      text-align: left;
      padding: 6px 16px 6px 0;
      background: #f8f9fa;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e8e8e8;
    }
    .table td {
      padding: 6px 16px 6px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 15px;
      color: #333;
    }
    .table tr:last-child td { border-bottom: none; }
    .table tr:hover { background: #f8f9ff; }
    .table .mono { font-family: 'SF Mono', Monaco, Consolas, monospace; }
    .table .label-cell { color: #666; white-space: nowrap; }
    .table .value-cell { font-weight: 600; text-align: right; padding-left: 24px; }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
    }
    .badge.good { background: #d1fae5; color: #065f46; }
    .badge.warn { background: #fef3c7; color: #92400e; }
    .badge.bad { background: #fee2e2; color: #991b1b; }
    .badge.info { background: #e0e7ff; color: #3730a3; }
    .badge.neutral { background: #f3f4f6; color: #374151; }
    .badge.large {
      padding: 8px 16px;
      font-size: 15px;
      border-radius: 6px;
    }

    /* Transcript Boxes */
    .transcript {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      background: #f8f9ff;
    }
    .transcript:last-child { margin-bottom: 0; }
    .transcript.expected { border-left-color: #94a3b8; background: #f8fafc; }
    .transcript.actual { border-left-color: #10b981; background: #f0fdf4; }
    .transcript .label {
      font-size: 13px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .transcript .text {
      font-size: 16px;
      line-height: 1.5;
      color: #1a1a2e;
    }

    /* Indicator Row */
    .indicators {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }
    .indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: #333;
    }
    .indicator .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #d1d5db;
    }
    .indicator .dot.active { background: #10b981; }

    /* Chips */
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip {
      padding: 5px 10px;
      border-radius: 5px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 14px;
      font-weight: 500;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .stat-item {
      text-align: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .stat-item .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a2e;
    }
    .stat-item .stat-label {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
      text-transform: uppercase;
    }

    /* Compact Metrics List */
    .metrics-list {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 4px 16px;
      align-items: center;
    }
    .metrics-list .m-label {
      font-size: 14px;
      color: #666;
    }
    .metrics-list .m-value {
      font-size: 15px;
      font-weight: 600;
      color: #1a1a2e;
      text-align: right;
    }

    /* 4-column content grid for compact display */
    .content-grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    /* Notes */
    .note {
      padding: 10px 14px;
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      border-radius: 0 6px 6px 0;
      margin-bottom: 8px;
      font-size: 15px;
      color: #92400e;
      line-height: 1.4;
    }

    /* Loading & Error */
    .loading { text-align: center; padding: 80px; color: #666; font-size: 16px; }
    .error { background: #fee2e2; color: #991b1b; padding: 24px; border-radius: 12px; text-align: center; margin: 24px; font-size: 16px; }

    /* Responsive */
    @media (max-width: 1200px) {
      .content-grid-4 { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 1000px) {
      .score-row { grid-template-columns: repeat(2, 1fr); }
      .content-grid { grid-template-columns: 1fr; }
      .content-grid-4 { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="app"><div class="loading">Loading analysis...</div></div>

  <script>
    const API = "http://127.0.0.1:8001";

    async function load() {
      const id = new URLSearchParams(location.search).get('recording_id');
      if (!id) return document.getElementById('app').innerHTML = '<div class="error">No recording ID specified</div>';
      try {
        const res = await fetch(`${API}/recording/${id}`);
        if (!res.ok) throw new Error('Recording not found');
        render(await res.json());
      } catch (e) {
        document.getElementById('app').innerHTML = `<div class="error">${e.message}</div>`;
      }
    }

    const scoreClass = (v, t=[0.8,0.5]) => v >= t[0] ? 'good' : v >= t[1] ? 'warn' : 'bad';
    const errClass = (v, t=[0.1,0.3]) => v <= t[0] ? 'good' : v <= t[1] ? 'warn' : 'bad';
    const pct = v => v != null ? (v * 100).toFixed(0) + '%' : 'N/A';
    const num = (v, d=1) => v != null ? Number(v).toFixed(d) : 'N/A';
    const fmt = v => v != null ? v : 'N/A';

    function render(r) {
      const pid = r.patient_id || r.session_id?.split('_')[0] || 'N/A';
      document.getElementById('app').innerHTML = `
        <div class="header">
          <div>
            <h1>Analysis #${r.id}: ${r.object_name || 'Unknown Object'}</h1>
            <div class="meta">Patient: ${pid} • ${new Date(r.created_at).toLocaleString()}</div>
          </div>
          <a href="/dashboard" class="back-btn">← Dashboard</a>
        </div>
        <div class="tabs">
          <button class="tab-btn active" data-tab="overview">Overview</button>
          <button class="tab-btn" data-tab="phoneme">Phoneme Analysis</button>
          <button class="tab-btn" data-tab="fluency">Fluency Analysis</button>
          <button class="tab-btn" data-tab="ml">ML Analysis</button>
          <button class="tab-btn" data-tab="raw">Raw Data</button>
        </div>
        <div class="main-content">
          ${overviewTab(r)}
          ${phonemeTab(r)}
          ${fluencyTab(r)}
          ${mlTab(r)}
          ${rawTab(r)}
        </div>
      `;
      initTabs();
    }

    function initTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        };
      });
    }

    function overviewTab(r) {
      const sem = r.semantic_score || 0;
      const per = r.per || 0;
      const flu = r.fluency_percentage || r.standard_fluency_pct || 0;
      const wpm = r.speech_rate;

      return `
        <div class="tab-panel active" id="tab-overview">
          <div class="score-row">
            <div class="score-card primary">
              <div class="value">${pct(sem)}</div>
              <div class="label">Semantic Score</div>
              <div class="bar"><div class="bar-fill" style="width:${sem*100}%"></div></div>
            </div>
            <div class="score-card">
              <div class="value ${errClass(per)}">${pct(per)}</div>
              <div class="label">Phoneme Error Rate</div>
              <div class="bar"><div class="bar-fill ${errClass(per)}" style="width:${Math.min(per*100,100)}%"></div></div>
            </div>
            <div class="score-card">
              <div class="value ${scoreClass(flu/100)}">${flu.toFixed(0)}%</div>
              <div class="label">Fluency Score</div>
              <div class="bar"><div class="bar-fill ${scoreClass(flu/100)}" style="width:${flu}%"></div></div>
            </div>
            <div class="score-card">
              <div class="value">${wpm ? wpm.toFixed(0) : 'N/A'}</div>
              <div class="label">Words Per Minute</div>
            </div>
          </div>

          <div class="content-grid">
            <div class="card">
              <div class="card-header"><h3>Speech Transcript</h3></div>
              <div class="card-body">
                <div class="transcript expected">
                  <div class="label">Expected Response</div>
                  <div class="text">${r.prompt_text || r.expected_answer || 'N/A'}</div>
                </div>
                <div class="transcript actual">
                  <div class="label">Patient's Response</div>
                  <div class="text">${r.transcript || '(No speech detected)'}</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3>Semantic Analysis</h3></div>
              <div class="card-body">
                <div style="margin-bottom:12px">
                  <span class="badge large ${(r.semantic_classification||'').toLowerCase()==='correct'?'good':(r.semantic_classification||'').toLowerCase()==='partial'?'warn':'bad'}">${r.semantic_classification || 'N/A'}</span>
                </div>
                <div class="metrics-list">
                  <span class="m-label">Overall Similarity</span><span class="m-value">${pct(r.semantic_score)}</span>
                  <span class="m-label">Direct Embedding</span><span class="m-value">${pct(r.direct_similarity)}</span>
                  <span class="m-label">Category Match</span><span class="m-value">${pct(r.category_similarity)}</span>
                  <span class="m-label">Word Error Rate</span><span class="m-value">${pct(r.wer)}</span>
                </div>
                <div class="indicators">
                  <div class="indicator"><span class="dot ${r.circumlocution_detected?'active':''}"></span> Circumlocution</div>
                  <div class="indicator"><span class="dot ${r.conduite_d_approche_detected?'active':''}"></span> Self-Correction</div>
                  <div class="indicator"><span class="dot ${r.semantic_paraphasia?.detected?'active':''}"></span> Paraphasia</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h3>Quick Statistics</h3></div>
            <div class="card-body">
              <div class="stats-grid">
                <div class="stat-item"><div class="stat-value">${r.total_phonemes||0}</div><div class="stat-label">Total Phonemes</div></div>
                <div class="stat-item"><div class="stat-value">${r.phoneme_errors?.length||0}</div><div class="stat-label">Phoneme Errors</div></div>
                <div class="stat-item"><div class="stat-value">${r.longest_fluent_run||0}</div><div class="stat-label">Longest Fluent Run</div></div>
                <div class="stat-item"><div class="stat-value">${r.pauses?.length||0}</div><div class="stat-label">Total Pauses</div></div>
                <div class="stat-item"><div class="stat-value">${num(r.articulation_rate)}</div><div class="stat-label">Articulation Rate</div></div>
                <div class="stat-item"><div class="stat-value">${r.ssi_severity||'N/A'}</div><div class="stat-label">SSI-4 Severity</div></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function phonemeTab(r) {
      let rows = '';
      if (r.phoneme_errors?.length) {
        r.phoneme_errors.forEach((e, i) => {
          const tc = e.type?.includes('deletion')?'bad':e.type?.includes('insertion')?'info':'warn';
          const t = (e.type||'unknown').replace('phonetically_similar_','Similar ').replace('phonetically_dissimilar_','Dissimilar ');
          rows += `<tr>
            <td>${i+1}</td>
            <td class="value-cell">${e.word||'-'}</td>
            <td class="mono">/${e.expected||'-'}/</td>
            <td class="mono">/${e.actual||'-'}/</td>
            <td><span class="badge ${tc}">${t}</span></td>
            <td class="label-cell">${e.clinical_significance||'-'}</td>
          </tr>`;
        });
      } else {
        rows = '<tr><td colspan="6" style="text-align:center;padding:32px;color:#666">No phoneme errors detected</td></tr>';
      }

      let probChips = '', classChips = '';
      if (r.problematic_phonemes) {
        Object.entries(r.problematic_phonemes).forEach(([p,c]) => {
          probChips += `<span class="chip" style="background:#fee2e2;color:#991b1b">/${p}/ × ${c}</span>`;
        });
      }
      if (r.phoneme_class_errors) {
        Object.entries(r.phoneme_class_errors).forEach(([k,v]) => {
          classChips += `<span class="chip" style="background:#e0e7ff;color:#3730a3">${k}: ${v}</span>`;
        });
      }

      return `
        <div class="tab-panel" id="tab-phoneme">
          <div class="score-row">
            <div class="score-card">
              <div class="value ${errClass(r.per||0)}">${pct(r.per)}</div>
              <div class="label">PER (Standard)</div>
            </div>
            <div class="score-card">
              <div class="value ${errClass(r.wper||0)}">${pct(r.wper)}</div>
              <div class="label">WPER (Weighted)</div>
            </div>
            <div class="score-card">
              <div class="value">${r.total_phonemes||0}</div>
              <div class="label">Total Phonemes</div>
            </div>
            <div class="score-card">
              <div class="value ${r.phoneme_errors?.length>3?'bad':r.phoneme_errors?.length>0?'warn':'good'}">${r.phoneme_errors?.length||0}</div>
              <div class="label">Errors Found</div>
            </div>
          </div>

          ${probChips||classChips?`
          <div class="content-grid">
            ${probChips?`<div class="card"><div class="card-header"><h3>Problematic Phonemes</h3></div><div class="card-body"><div class="chips">${probChips}</div></div></div>`:''}
            ${classChips?`<div class="card"><div class="card-header"><h3>Errors by Class</h3></div><div class="card-body"><div class="chips">${classChips}</div></div></div>`:''}
          </div>
          `:''}

          <div class="card">
            <div class="card-header"><h3>Phoneme Error Details</h3></div>
            <div class="card-body" style="padding:0">
              <table class="table">
                <thead><tr><th>#</th><th>Word</th><th>Expected</th><th>Actual</th><th>Type</th><th>Clinical Note</th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>

          ${r.error_pattern_analysis&&Object.keys(r.error_pattern_analysis).length?`
          <div class="card">
            <div class="card-header"><h3>Error Pattern Analysis</h3></div>
            <div class="card-body">
              <table class="table">
                ${r.error_pattern_analysis.dominant_error_type?`<tr><td class="label-cell">Dominant Error Type</td><td class="value-cell">${r.error_pattern_analysis.dominant_error_type}</td></tr>`:''}
                ${r.error_pattern_analysis.most_affected_position?`<tr><td class="label-cell">Most Affected Position</td><td class="value-cell">${r.error_pattern_analysis.most_affected_position}</td></tr>`:''}
                ${r.error_pattern_analysis.substitution_pattern?`<tr><td class="label-cell">Substitution Pattern</td><td class="value-cell">${r.error_pattern_analysis.substitution_pattern}</td></tr>`:''}
                ${r.error_pattern_analysis.consistency?`<tr><td class="label-cell">Error Consistency</td><td class="value-cell">${r.error_pattern_analysis.consistency}</td></tr>`:''}
              </table>
            </div>
          </div>
          `:''}
        </div>
      `;
    }

    function fluencyTab(r) {
      const flu = r.fluency_percentage || r.standard_fluency_pct || 0;

      let pauseRows = '';
      if (r.pauses?.length) {
        r.pauses.slice(0,12).forEach((p,i) => {
          const tc = p.type==='anomic'?'warn':p.type==='block'?'bad':'info';
          pauseRows += `<tr><td>${i+1}</td><td><span class="badge ${tc}">${p.type||'pause'}</span></td><td>${num(p.duration,2)}s</td></tr>`;
        });
        if (r.pauses.length > 12) pauseRows += `<tr><td colspan="3" style="text-align:center;color:#666">+ ${r.pauses.length-12} more pauses</td></tr>`;
      }

      return `
        <div class="tab-panel" id="tab-fluency">
          <div class="score-row">
            <div class="score-card primary">
              <div class="value">${flu.toFixed(0)}%</div>
              <div class="label">Fluency Score</div>
              <div class="bar"><div class="bar-fill" style="width:${flu}%"></div></div>
            </div>
            <div class="score-card">
              <div class="value">${r.longest_fluent_run||0}</div>
              <div class="label">Longest Fluent Run</div>
            </div>
            <div class="score-card">
              <div class="value">${num(r.articulation_rate)}</div>
              <div class="label">Articulation Rate</div>
            </div>
            ${r.ssi_severity?`
            <div class="score-card">
              <div class="value"><span class="badge large ${r.ssi_severity==='normal'||r.ssi_severity==='mild'?'good':r.ssi_severity==='moderate'?'warn':'bad'}">${r.ssi_severity.toUpperCase()}</span></div>
              <div class="label">SSI-4 (Score: ${r.ssi_total_score||'?'})</div>
            </div>
            `:`<div class="score-card"><div class="value">N/A</div><div class="label">SSI-4 Severity</div></div>`}
          </div>

          <div class="content-grid-4">
            <div class="card">
              <div class="card-header"><h3>Dysfluency Metrics</h3></div>
              <div class="card-body">
                <div class="metrics-list">
                  <span class="m-label">Total Pauses</span><span class="m-value">${r.pauses?.length||0}</span>
                  <span class="m-label">Anomic Pauses</span><span class="m-value">${r.anomic_pause_count||0}</span>
                  <span class="m-label">Apraxic Pauses</span><span class="m-value">${r.apraxic_pause_count||0}</span>
                  <span class="m-label">Hesitations</span><span class="m-value">${r.hesitation_count||0}</span>
                  <span class="m-label">Blocks</span><span class="m-value">${r.block_count||0}</span>
                  <span class="m-label">Dysfl./100 Words</span><span class="m-value">${num(r.dysfluencies_per_100_words)}</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3>Speech Timing</h3></div>
              <div class="card-body">
                <div class="metrics-list">
                  <span class="m-label">Speaking Rate</span><span class="m-value">${num(r.speaking_rate)} syl/m</span>
                  <span class="m-label">Pause-Adj Rate</span><span class="m-value">${num(r.pause_adjusted_rate)} syl/m</span>
                  <span class="m-label">Phonation Time</span><span class="m-value">${num(r.phonation_time,2)}s</span>
                  <span class="m-label">Phonation Ratio</span><span class="m-value">${pct(r.phonation_ratio)}</span>
                  <span class="m-label">Mean Pause Dur.</span><span class="m-value">${num(r.mean_pause_duration,2)}s</span>
                  <span class="m-label">Pathological %</span><span class="m-value">${pct(r.pathological_pause_ratio)}</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3>Rate Variability ${r.rate_trend?`<span class="badge ${r.rate_trend==='stable'?'good':'warn'}">${r.rate_trend}</span>`:''}</h3></div>
              <div class="card-body">
                <div class="metrics-list">
                  <span class="m-label">Local CV</span><span class="m-value">${num(r.local_cv,3)}</span>
                  <span class="m-label">Global CV</span><span class="m-value">${num(r.global_cv,3)}</span>
                  <span class="m-label">Normalized PVI</span><span class="m-value">${num(r.normalized_pvi,3)}</span>
                  <span class="m-label">Rate Variability</span><span class="m-value">${num(r.speech_rate_variability,3)}</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3>Fluency Scores</h3></div>
              <div class="card-body">
                <div class="metrics-list">
                  <span class="m-label">Standard</span><span class="m-value">${num(r.standard_fluency_pct,0)}%</span>
                  <span class="m-label">Weighted</span><span class="m-value">${num(r.weighted_fluency_pct,0)}%</span>
                  <span class="m-label">Clinical</span><span class="m-value">${num(r.clinical_fluency_pct,0)}%</span>
                  <span class="m-label">LFR Ratio</span><span class="m-value">${pct(r.lfr_ratio)}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="content-grid">
          ${r.ssi_severity?`
            <div class="card">
              <div class="card-header"><h3>SSI-4 Breakdown</h3></div>
              <div class="card-body">
                <div class="metrics-list">
                  <span class="m-label">Frequency</span><span class="m-value">${num(r.ssi_frequency_pct)}% → ${r.ssi_frequency_score||'?'}/10</span>
                  <span class="m-label">Duration</span><span class="m-value">${num(r.ssi_avg_duration,2)}s → ${r.ssi_duration_score||'?'}/10</span>
                  <span class="m-label" style="font-weight:600">Total Score</span><span class="m-value" style="font-size:18px">${r.ssi_total_score||'?'}</span>
                </div>
              </div>
            </div>
          `:''}

          ${pauseRows?`
            <div class="card">
              <div class="card-header"><h3>Pause Log</h3></div>
              <div class="card-body" style="padding:0;max-height:180px;overflow-y:auto">
                <table class="table">
                  <thead><tr><th>#</th><th>Type</th><th>Duration</th></tr></thead>
                  <tbody>${pauseRows}</tbody>
                </table>
              </div>
            </div>
          `:''}
          </div>

          ${(r.clinical_notes?.length||r.fluency_notes?.length)?`
          <div class="card">
            <div class="card-header"><h3>Clinical Notes</h3></div>
            <div class="card-body">
              ${[...(r.clinical_notes||[]),...(r.fluency_notes||[])].map(n=>`<div class="note">${n}</div>`).join('')}
            </div>
          </div>
          `:''}
        </div>
      `;
    }

    function mlTab(r) {
      let alignChips = '', detChips = '', ipaChips = '';

      if (r.ml_alignment?.length) {
        r.ml_alignment.slice(0,30).forEach(p => {
          const [e,d] = Array.isArray(p) ? p : [p.expected, p.detected];
          const match = e === d;
          alignChips += `<span class="chip" style="background:${match?'#d1fae5':'#fee2e2'};color:${match?'#065f46':'#991b1b'}">${e||'?'} → ${d||'?'}</span>`;
        });
        if (r.ml_alignment.length > 30) alignChips += `<span style="color:#666;margin-left:8px">+ ${r.ml_alignment.length-30} more</span>`;
      }
      if (r.ml_detected_phonemes?.length) {
        r.ml_detected_phonemes.forEach(p => detChips += `<span class="chip" style="background:#e0e7ff;color:#3730a3">${p}</span>`);
      }
      if (r.ml_detected_ipa?.length) {
        r.ml_detected_ipa.forEach(p => ipaChips += `<span class="chip" style="background:#fef3c7;color:#92400e">${p}</span>`);
      }

      return `
        <div class="tab-panel" id="tab-ml">
          <div class="score-row">
            <div class="score-card">
              <div class="value ${errClass(r.ml_per||0)}">${pct(r.ml_per)}</div>
              <div class="label">ML Phoneme Error Rate</div>
            </div>
            <div class="score-card">
              <div class="value">${num(r.ml_gop,2)}</div>
              <div class="label">GOP Score</div>
            </div>
            <div class="score-card">
              <div class="value ${scoreClass(r.ml_confidence||0)}">${pct(r.ml_confidence)}</div>
              <div class="label">Confidence</div>
            </div>
            <div class="score-card">
              <div class="value">${r.ml_detected_phonemes?.length||0}</div>
              <div class="label">Detected Phonemes</div>
            </div>
          </div>

          ${detChips?`
          <div class="card">
            <div class="card-header"><h3>Detected Phonemes (ARPAbet)</h3></div>
            <div class="card-body"><div class="chips">${detChips}</div></div>
          </div>
          `:''}

          ${ipaChips?`
          <div class="card">
            <div class="card-header"><h3>Detected Phonemes (IPA)</h3></div>
            <div class="card-body"><div class="chips">${ipaChips}</div></div>
          </div>
          `:''}

          ${alignChips?`
          <div class="card">
            <div class="card-header"><h3>Phoneme Alignment (Expected → Detected)</h3></div>
            <div class="card-body">
              <div class="chips">${alignChips}</div>
              <div style="margin-top:16px">
                <span class="chip" style="background:#d1fae5;color:#065f46">Match</span>
                <span class="chip" style="background:#fee2e2;color:#991b1b;margin-left:8px">Mismatch</span>
              </div>
            </div>
          </div>
          `:''}

          ${r.ml_phoneme_scores?.length?`
          <div class="card">
            <div class="card-header"><h3>Per-Phoneme Quality Scores</h3></div>
            <div class="card-body">
              <div class="chips">
                ${r.ml_phoneme_scores.slice(0,30).map(s => {
                  const p = s.probability || 0;
                  const cls = p > 0.9 ? 'good' : p > 0.7 ? 'warn' : 'bad';
                  return `<span class="chip badge ${cls}">${s.phoneme} ${(p*100).toFixed(0)}%</span>`;
                }).join('')}
                ${r.ml_phoneme_scores.length > 30 ? `<span style="color:#666;margin-left:8px">+ ${r.ml_phoneme_scores.length-30} more</span>` : ''}
              </div>
            </div>
          </div>
          `:''}
        </div>
      `;
    }

    function rawTab(r) {
      return `
        <div class="tab-panel" id="tab-raw">
          <div class="card">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
              <h3 style="margin:0">Raw JSON Data</h3>
              <button onclick="copyJSON()" style="padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500">Copy to Clipboard</button>
            </div>
            <div class="card-body">
              <pre id="json-data" style="background:#1e293b;color:#e2e8f0;padding:20px;border-radius:8px;overflow:auto;max-height:600px;font-size:13px;line-height:1.6;font-family:'SF Mono',Monaco,Consolas,monospace">${JSON.stringify(r,null,2).replace(/</g,'&lt;')}</pre>
            </div>
          </div>
        </div>
      `;
    }

    function copyJSON() {
      navigator.clipboard.writeText(document.getElementById('json-data').textContent).then(() => {
        const btn = event.target;
        btn.textContent = '✓ Copied!';
        btn.style.background = '#10b981';
        setTimeout(() => { btn.textContent = 'Copy to Clipboard'; btn.style.background = '#667eea'; }, 2000);
      });
    }

    load();
  </script>
</body>
</html>
